# 历史记录诊断工具使用说明

## 问题描述

如果你发现历史记录功能不工作（下拉菜单没有内容，保存后历史记录没有保存），请使用诊断工具来查找原因。

## 使用步骤

### 1. 打开诊断工具

在编辑窗口中（单文件编辑或批量编辑），点击底部的 **"历史诊断"** 按钮。

- **单文件编辑窗口**：右键文件 → 选择编辑选项 → 点击底部"历史诊断"按钮
- **批量编辑窗口**：选择多个文件 → 右键批量编辑 → 点击底部"历史诊断"按钮

### 2. 查看诊断信息

诊断工具会显示以下信息：

#### ① 数据库路径信息
```
数据库路径: D:\...\WriteRemark\bin\Debug\InputHistory.db
数据库文件存在: True/False
数据库文件大小: XXX 字节
创建时间: 2025-XX-XX XX:XX:XX
最后修改: 2025-XX-XX XX:XX:XX
```

**重点检查**：
- 数据库文件是否存在
- 文件大小是否 > 0（如果是0字节，说明数据库创建失败）
- 最后修改时间是否最近（如果很久没更新，说明没有保存新记录）

#### ② 测试写入
```
--- 测试写入 ---
✓ 成功添加测试记录: 测试_123456
```

**如果显示**：
- ✓ 成功 → 写入功能正常
- ✗ 失败 → 数据库有问题，查看错误信息

#### ③ 测试读取
```
--- 测试读取 ---
✓ 读取到 3 条测试记录
最近的记录:
  1. 测试_123456
  2. 测试_123123
  3. 测试_122345
```

**如果显示**：
- ✓ 读取到记录 → 读取功能正常
- ✗ 失败 → 数据库读取有问题

#### ④ 各字段历史记录统计
```
--- 各字段历史记录统计 ---
Title: 5 条记录
Subject: 3 条记录
Tags: 8 条记录
Comment: 12 条记录
```

**如果这里没有显示任何字段**：
- 说明你还没有保存过任何历史记录
- 或者历史记录保存功能有问题

#### ⑤ 程序信息
```
--- 程序信息 ---
程序路径: D:\...\WriteRemark.dll
工作目录: D:\...
```

这些信息可以帮助定位数据库文件的位置。

## 常见问题及解决方法

### 问题1：数据库文件不存在

**症状**：
```
数据库文件存在: False
```

**原因**：
- SQLite初始化失败
- 没有文件写入权限
- 程序目录只读

**解决方法**：
1. 检查程序目录是否有写入权限
2. 尝试以管理员身份运行程序
3. 检查是否被杀毒软件拦截

### 问题2：数据库文件大小为0

**症状**：
```
数据库文件存在: True
数据库文件大小: 0 字节
```

**原因**：
- 数据库创建失败
- SQL表创建失败

**解决方法**：
1. 删除 `InputHistory.db` 文件
2. 重新启动程序，让它重新创建数据库
3. 如果还是失败，查看测试写入的错误信息

### 问题3：写入失败

**症状**：
```
--- 测试写入 ---
✗ 添加测试记录失败: [错误信息]
```

**常见错误及解决方法**：

- **"unable to open database file"**
  - 数据库文件被锁定或权限不足
  - 关闭其他正在访问该数据库的程序
  - 检查文件权限

- **"no such table: InputHistory"**
  - 数据库表未创建
  - 删除数据库文件重新初始化

- **"database is locked"**
  - 另一个进程正在使用数据库
  - 关闭其他 WriteRemark 窗口
  - 重启程序

### 问题4：能写入但读取为空

**症状**：
```
--- 测试写入 ---
✓ 成功添加测试记录

--- 测试读取 ---
✓ 读取到 0 条测试记录
```

**原因**：
- 写入和读取使用了不同的数据库文件
- 事务未提交

**解决方法**：
1. 重启程序
2. 清除并重新创建数据库

### 问题5：历史记录统计为空

**症状**：
```
--- 各字段历史记录统计 ---
(空)
```

**原因**：
- 你还没有保存过任何数据
- 保存时没有调用历史记录功能

**解决方法**：
1. **测试保存功能**：
   - 打开单文件编辑窗口
   - 在"标题"字段输入"测试标题123"
   - 点击"保存"按钮
   - 再次点击"历史诊断"按钮
   - 查看是否出现 `Title: 1 条记录`

2. **如果保存后还是没有记录**：
   - 说明保存时没有调用 `HistoryManager.AddOrUpdateHistory`
   - 检查代码是否正确集成

## 手动测试历史记录功能

### 测试单文件编辑

1. 右键一个文件 → 选择编辑选项
2. 在"标题"字段输入："我的测试标题"
3. 点击"保存"按钮
4. 关闭窗口
5. 再次右键同一个文件 → 选择编辑选项
6. 点击"标题"字段的下拉箭头
7. **应该看到**："我的测试标题" 出现在下拉列表中

### 测试批量编辑

1. 选择多个文件 → 右键批量编辑
2. 在文件批量操作区域：
   - 选择字段："标题"
   - 输入值："批量测试标题"
   - 点击"应用到选中"
3. 点击"保存全部"
4. 关闭窗口
5. 再次打开批量编辑窗口
6. 在批量操作输入框中点击下拉箭头
7. **应该看到**："批量测试标题" 出现在下拉列表中

## 清理和重置

### 清理历史记录数据库

如果历史记录出现问题，可以尝试重置：

1. 点击"历史诊断"按钮
2. 记下数据库路径（例如：`D:\...\WriteRemark\bin\Debug\InputHistory.db`）
3. 关闭所有 WriteRemark 窗口
4. 在文件管理器中找到该文件
5. 删除 `InputHistory.db` 文件
6. 重新启动程序，数据库会自动重建

### 查看数据库内容（高级）

如果你想查看数据库的详细内容：

1. 下载 [DB Browser for SQLite](https://sqlitebrowser.org/)
2. 用它打开 `InputHistory.db` 文件
3. 查看 `InputHistory` 表的内容
4. 检查数据是否正确保存

## 联系开发者

如果以上方法都无法解决问题，请：

1. 点击"历史诊断"按钮
2. 截图诊断信息
3. 描述你的操作步骤
4. 提供截图和描述给开发者

---

**版本**: 1.0.1-fix2  
**更新日期**: 2025-01-29


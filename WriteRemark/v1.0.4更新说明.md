# v1.0.4 更新说明 (2025-10-29)

## 🐛 Bug 修复：显示更多历史记录功能

### ❌ 问题现象
用户反馈点击 "... 显示更多历史记录 ..." 后：
1. ✗ 输入框内容变空白
2. ✗ 下拉菜单消失
3. ✗ 历史记录没有增多

### 🔍 问题根源

原代码中，点击"显示更多"时直接设置 `SelectedIndex = -1`：

```csharp
// ❌ 旧代码：会清空文本
if (selectedText == SHOW_MORE_PLACEHOLDER)
{
    LoadHistory(comboBox, fieldName, showAll: true);
    comboBox.IsDropDownOpen = true;
    comboBox.SelectedIndex = -1;  // ← 这会清空 Text！
}
```

**问题**：
- 在 WPF 中，设置 `SelectedIndex = -1` 会清除选中项
- 对于可编辑的 ComboBox，这也会清空 `Text` 属性
- 在 DataGrid 绑定场景下，会导致数据丢失

### ✅ 解决方案

#### 1. **保存并恢复文本**
```csharp
// 保存当前文本
string currentText = comboBox.Text;

// 展开显示全部历史记录
LoadHistory(comboBox, fieldName, showAll: true);

// 恢复文本
comboBox.Text = currentText;
```

#### 2. **使用 Dispatcher 延迟清除选择**
```csharp
// 使用 Dispatcher 确保 UI 更新完成后再清除选择
comboBox.Dispatcher.BeginInvoke(new Action(() =>
{
    comboBox.SelectedIndex = -1;
}), System.Windows.Threading.DispatcherPriority.Background);
```

**为什么需要 Dispatcher？**
- `LoadHistory` 会更新 `ItemsSource`
- UI 需要时间重新渲染下拉列表
- 延迟执行确保渲染完成后再清除选择
- 避免文本被清空

### 📊 修复效果

| 操作 | 修复前 | 修复后 |
|-----|--------|--------|
| 点击"显示更多" | ✗ 文本清空 | ✅ 文本保留 |
| 下拉菜单 | ✗ 消失 | ✅ 保持打开 |
| 历史记录显示 | ✗ 未增多 | ✅ 显示30条 |
| DataGrid 绑定 | ✗ 数据丢失 | ✅ 数据保留 |

### 🎯 使用演示

#### 修复前
```
1. 输入框有内容："我的文档"
2. 点击下拉箭头
3. 看到5条历史 + "... 显示更多 ..."
4. 点击"... 显示更多 ..."
5. ✗ 输入框变空白！
6. ✗ 下拉菜单消失！
```

#### 修复后
```
1. 输入框有内容："我的文档"
2. 点击下拉箭头
3. 看到5条历史 + "... 显示更多 ..."
4. 点击"... 显示更多 ..."
5. ✅ 输入框保持："我的文档"
6. ✅ 下拉菜单展开，显示最多30条历史记录
7. ✅ 可以继续选择或输入
```

### 📝 修改文件

1. **HistoryComboBoxHelper.cs**
   - 修复 `AttachMinimalEvents` 中的"显示更多"逻辑
   - 修复 `SetupComboBoxEvents` 中的"显示更多"逻辑

2. **Version.cs**
   - 版本号：v1.0.3 → **v1.0.4**

### 🎉 测试步骤

1. 打开批量编辑窗口
2. 双击单元格进入编辑模式
3. 输入一些文本（或保持现有内容）
4. 点击下拉箭头
5. 点击 **"... 显示更多历史记录 ..."**
6. ✅ 输入框内容应该保持不变
7. ✅ 下拉菜单应该展开显示更多记录
8. ✅ 可以选择任意历史记录

---

**下一个版本将是 v1.0.5**（如有新的改动）


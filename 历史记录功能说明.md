# 历史记录功能说明

## 功能概述

已为WriteRemark项目添加了类似Everything的历史记录功能，使用SQLite数据库存储输入历史。

## 主要特性

### 1. **自动历史记录**
- 所有输入框在保存时自动记录到SQLite数据库
- 数据库文件：`InputHistory.db`（存储在DLL所在目录）
- 自动保留90天的历史记录，超过90天的记录会自动清理

### 2. **智能下拉建议**
- 每个输入框都变成了带历史记录的ComboBox
- 点击下拉箭头：显示最近使用的20条历史记录
- 输入时自动显示匹配建议：
  - 模糊匹配输入内容
  - 优先显示以输入内容开头的记录
  - 按使用频率和最后使用时间排序

### 3. **自动完成**
- 输入时实时显示匹配的历史记录
- 支持部分匹配（包含关系）
- 优先匹配开头，其次匹配中间部分

## 技术实现

### 新增文件

1. **HistoryManager.cs**
   - SQLite数据库管理
   - 历史记录的增删改查
   - 自动清理90天前的记录

2. **HistoryComboBoxHelper.cs**
   - 将普通TextBox改造为带历史记录的ComboBox
   - 提供自动建议功能
   - 管理历史记录的加载和保存

### 修改的文件

1. **PropertyEditorWindow.xaml & .xaml.cs**
   - TextBox → ComboBox（带历史记录）
   - 保存时自动记录到历史

2. **FolderPropertyEditorWindow.xaml & .xaml.cs**
   - TextBox → ComboBox（带历史记录）
   - 保存时自动记录到历史

3. **packages.config**
   - 添加 System.Data.SQLite.Core 1.0.118.0

4. **WriteRemark.csproj**
   - 添加SQLite引用
   - 添加新源文件

## 数据库结构

```sql
CREATE TABLE InputHistory (
    Id INTEGER PRIMARY KEY AUTOINCREMENT,
    FieldName TEXT NOT NULL,           -- 字段名（Title, Subject等）
    Value TEXT NOT NULL,                -- 输入值
    LastUsed DATETIME NOT NULL,         -- 最后使用时间
    UseCount INTEGER DEFAULT 1,         -- 使用次数
    UNIQUE(FieldName, Value)            -- 同字段同值唯一
);

CREATE INDEX idx_field_lastused ON InputHistory(FieldName, LastUsed DESC);
CREATE INDEX idx_field_value ON InputHistory(FieldName, Value);
```

## 字段映射

### 文件属性字段
- `Title` - 标题
- `Subject` - 主题
- `Rating` - 分级
- `Tags` - 标记
- `Category` - 类别
- `Comment` - 备注

### 文件夹属性字段
- `LocalizedResourceName` - 别名
- `InfoTip` - 备注
- `Prop2` - 标题
- `Prop3` - 主题
- `Prop4` - 作者
- `Prop5` - 标记

## 使用方式

### 普通使用
1. 在任何输入框中输入内容
2. 点击"保存"按钮，内容自动记录到历史
3. 下次打开时，点击下拉箭头即可看到历史记录

### 自动建议
1. 在输入框中开始输入
2. 系统自动显示匹配的历史记录
3. 可以直接选择历史记录，无需重新输入

### 清理历史
- 自动清理：系统启动时自动删除90天前的记录
- 手动清理：可通过 `HistoryManager.ClearFieldHistory(fieldName)` 清空指定字段
- 全部清理：可通过 `HistoryManager.ClearAllHistory()` 清空所有历史

## 注意事项

1. **首次使用**
   - 需要安装 System.Data.SQLite.Core NuGet包
   - 在Visual Studio中右键解决方案 → "还原NuGet程序包"

2. **数据库位置**
   - 数据库文件在WriteRemark.dll所在目录
   - 文件名：`InputHistory.db`
   - 可以删除此文件来清空所有历史

3. **性能**
   - SQLite是文件数据库，响应速度极快
   - 历史记录查询已优化索引
   - 自动建议限制在10条以内，保证流畅

4. **兼容性**
   - 完全兼容现有功能
   - 如果SQLite出错，不影响主要功能
   - 所有历史记录操作都有错误处理

## API参考

### HistoryManager 主要方法

```csharp
// 添加或更新历史记录
HistoryManager.AddOrUpdateHistory(string fieldName, string value)

// 获取历史记录
List<string> history = HistoryManager.GetHistory(string fieldName, int limit = 20)

// 搜索历史记录（模糊匹配）
List<string> matches = HistoryManager.SearchHistory(string fieldName, string searchText, int limit = 10)

// 删除指定记录
HistoryManager.DeleteHistory(string fieldName, string value)

// 清空字段历史
HistoryManager.ClearFieldHistory(string fieldName)

// 清空所有历史
HistoryManager.ClearAllHistory()

// 获取数据库路径
string dbPath = HistoryManager.GetDatabasePath()
```

### HistoryComboBoxHelper 主要方法

```csharp
// 创建带历史记录的ComboBox
ComboBox cb = HistoryComboBoxHelper.CreateHistoryComboBox(string fieldName, bool isMultiLine = false)

// 为现有ComboBox添加历史功能
HistoryComboBoxHelper.AttachHistoryFeature(ComboBox comboBox, string fieldName)

// 设置/获取文本
HistoryComboBoxHelper.SetText(ComboBox comboBox, string text)
string text = HistoryComboBoxHelper.GetText(ComboBox comboBox)
```

## 开发者说明

如需扩展历史记录功能到BatchPropertyEditorWindow，可参考PropertyEditorWindow的修改方式：

1. 将 `Dictionary<string, TextBox>` 改为 `Dictionary<string, ComboBox>`
2. 使用 `HistoryComboBoxHelper.CreateHistoryComboBox(fieldName)` 创建控件
3. 在保存时调用 `HistoryManager.AddOrUpdateHistory(fieldName, value)`

---

**版本**: 1.0.1
**创建日期**: 2025-01-29
**开发者**: Claude Code
